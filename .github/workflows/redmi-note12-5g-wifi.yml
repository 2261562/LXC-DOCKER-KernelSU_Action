name: Redmi Note 12 5G GKI (Wi-Fi 修复版)
on:
  workflow_dispatch:

jobs:
  build:
    name: Build GKI Kernel
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      KERNEL_SOURCE: https://github.com/MiCode/Xiaomi_Kernel_OpenSource/
      KERNEL_SOURCE_BRANCH: moonstone-s-oss
      KERNEL_CONFIG: sunstone_defconfig
      KERNEL_ZIP_NAME: sunstone_wifi_lxc-docker-kernel_20251217
      LLVM_CONFIG: y
      KERNEL_IMAGE_NAME: Image
      NEED_DTBO: true
      ENABLE_KVM: false
      ENABLE_LXC_DOCKER: true
      ENABLE_KERNELSU: true
      KERNELSU_TAG: main

    steps:
    - uses: actions/checkout@v3
    

    - name: 构建编译内核环境
      run: |
        sudo apt-get update
        sudo -E apt-get -y -qq install git make bc bison ccache openssl zip kmod cpio flex libelf-dev curl libssl-dev libtfm-dev wget device-tree-compiler ca-certificates python3 binutils binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace
                     
    - name: 下载 zyc-clang 编译器
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir clang-zyc
        # 链接文件可能会失效，这里保持你原有的逻辑，但建议检查链接有效性
        wget https://github.com/ZyCromerZ/Clang/releases/download/18.0.0-20230903-release/Clang-18.0.0-20230903.tar.gz
        tar -C clang-zyc/ -zxf Clang-18.0.0-20230903.tar.gz
              
    - name: 下载内核源码
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1
                      
    - name: 开启 LXC 和 Docker 配置
      if: env.ENABLE_LXC_DOCKER == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        chmod 755 $GITHUB_WORKSPACE/add-lxc-docker-custom.sh
        $GITHUB_WORKSPACE/add-lxc-docker-custom.sh android-kernel/arch/arm64/configs/${{ env.KERNEL_CONFIG }}
        echo "# CONFIG_ANDROID_PARANOID_NETWORK is not set" >> android-kernel/arch/arm64/configs/${{ env.KERNEL_CONFIG }}

    # ------------------- 核心修复步骤：解决 Wi-Fi 丢失 -------------------
    - name: 配置允许加载旧模块 (解决 Wi-Fi/音频 丢失)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        
        # 定义配置文件路径
        CONFIG_FILE="arch/arm64/configs/${{ env.KERNEL_CONFIG }}"
        
        echo "正在修改配置文件以禁用模块校验..."
        
        # 1. 禁用模块版本校验 (CONFIG_MODVERSIONS)
        # 这样内核就不会检查模块的 CRC 校验码，允许旧模块加载
        sed -i 's/CONFIG_MODVERSIONS=y/CONFIG_MODVERSIONS=n/g' $CONFIG_FILE
        echo "CONFIG_MODVERSIONS=n" >> $CONFIG_FILE
        
        # 2. 允许强制加载模块 (CONFIG_MODULE_FORCE_LOAD)
        # 允许使用 insmod -f 强制加载（作为备用手段）
        echo "CONFIG_MODULE_FORCE_LOAD=y" >> $CONFIG_FILE
        
        # 3. 禁用内核模块签名强制校验 (CONFIG_MODULE_SIG_FORCE)
        # 防止内核因为签名不对而拒绝模块
        sed -i 's/CONFIG_MODULE_SIG_FORCE=y/CONFIG_MODULE_SIG_FORCE=n/g' $CONFIG_FILE
        echo "# CONFIG_MODULE_SIG_FORCE is not set" >> $CONFIG_FILE
        
        # 4. 禁用严格的模块全版本检查 (CONFIG_MODULE_SCMVERSION)
        # 这是 Android GKI 特有的严格检查，必须关闭
        sed -i 's/CONFIG_MODULE_SCMVERSION=y/CONFIG_MODULE_SCMVERSION=n/g' $CONFIG_FILE
        echo "# CONFIG_MODULE_SCMVERSION is not set" >> $CONFIG_FILE
        
        echo "模块校验已禁用，Wi-Fi 驱动应该可以正常加载了。"
    # -------------------------------------------------------------------
    
    - name: 修复 GKI 编译问题
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        
        # 统一放宽栈帧大小限制，解决大部分编译报错
        echo "KBUILD_CFLAGS += -Wno-error=frame-larger-than" >> Makefile
        echo "KBUILD_CFLAGS += -Wframe-larger-than=8192" >> Makefile
        
        # 禁用严格函数原型检查 (Clang 16+ 常见报错)
        echo "KBUILD_CFLAGS += -Wno-error=strict-prototypes" >> Makefile
        
        # 特定文件修复 (保留你原有的逻辑作为补充)
        if [ -f drivers/misc/perf_helper.c ]; then
          sed -i 's/static void kswapd_task_show()/static void kswapd_task_show(void)/g' drivers/misc/perf_helper.c
        fi

    - name: 配置 KernelSU
      if: env.ENABLE_KERNELSU == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ env.KERNELSU_TAG }}

    - name: 开启 KVM
      if: env.ENABLE_KVM == 'true'
      run: |
         cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
         echo "CONFIG_VIRTUALIZATION=y" >> arch/arm64/configs/${{ env.KERNEL_CONFIG }}
         echo "CONFIG_KVM=y" >> arch/arm64/configs/${{ env.KERNEL_CONFIG }}
         # GKI 内核通常需要开启这些以支持虚拟化网络
         echo "CONFIG_VHOST_NET=y" >> arch/arm64/configs/${{ env.KERNEL_CONFIG }}
         echo "CONFIG_VHOST_CROSS_ENDIAN_LEGACY=y" >> arch/arm64/configs/${{ env.KERNEL_CONFIG }}
                     
    - name: 设置 ccache 缓存
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: build-kernel-gki-${{ env.KERNEL_CONFIG }}
        max-size: 2G

    - name: 开始编译内核
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-zyc/bin:$PATH
        export KBUILD_BUILD_HOST=GKI
        export KBUILD_BUILD_USER=Builder
        
        # 先生成配置 (这是编译的关键一步，不能省)
        make -s ARCH=arm64 O=out ${{ env.KERNEL_CONFIG }}
        
        # 开始编译
        if [ "${{ env.LLVM_CONFIG }}" = "y" ]; then
            make -j$(nproc --all) \
                O=out \
                ARCH=arm64 \
                CC="ccache clang" \
                CXX="ccache clang++" \
                CLANG_TRIPLE="aarch64-linux-gnu-" \
                CROSS_COMPILE="aarch64-linux-gnu-" \
                CROSS_COMPILE_ARM32="arm-linux-gnueabi-" \
                LLVM=1 \
                LLVM_IAS=1
        else
            make -j$(nproc --all) \
                O=out \
                ARCH=arm64 \
                CC="ccache clang" \
                CXX="ccache clang++" \
                CLANG_TRIPLE="aarch64-linux-gnu-" \
                CROSS_COMPILE="aarch64-linux-gnu-" \
                CROSS_COMPILE_ARM32="arm-linux-gnueabi-"
        fi
                
    - name: 准备打包内核
      run: |       
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://github.com/osm0sis/AnyKernel3
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
        sed -i 's!block=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!block=auto;!g' AnyKernel3/anykernel.sh
        sed -i 's/is_slot_device=1;/is_slot_device=auto;/g' AnyKernel3/anykernel.sh        
        
        # 复制内核镜像
        cp android-kernel/out/arch/arm64/boot/${{ env.KERNEL_IMAGE_NAME }} AnyKernel3/
        
        # 处理 DTBO
        if [ "${{ env.NEED_DTBO }}" = "true" ]; then
            if [ -f android-kernel/out/arch/arm64/boot/dtbo.img ]; then
                cp android-kernel/out/arch/arm64/boot/dtbo.img AnyKernel3/
                echo "DTBO_FOUND=true" >> $GITHUB_ENV
            else
                echo "Warning: DTBO requested but not generated!"
            fi
        fi  
        
        rm -rf AnyKernel3/.git* AnyKernel3/README.md
        rm -rf AnyKernel3/ramdisk AnyKernel3/modules AnyKernel3/patch
        
    - name: 上传内核
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_ZIP_NAME }}
        path: kernel_workspace/AnyKernel3/*

    - name: 上传 dtbo 镜像 (可选)
      if: env.DTBO_FOUND == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: dtbo-image
        path: kernel_workspace/android-kernel/out/arch/arm64/boot/dtbo.img