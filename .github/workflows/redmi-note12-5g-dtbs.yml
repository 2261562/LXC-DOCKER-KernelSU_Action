name: Redmi Note 12 5G DTBS
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel (GKI Merge)
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      KERNEL_SOURCE: https://github.com/MiCode/Xiaomi_Kernel_OpenSource/
      KERNEL_SOURCE_BRANCH: moonstone-s-oss
      KERNEL_ZIP_NAME: beryl_lxc-docker-kernel_20251217
      LLVM_CONFIG: y
      KERNEL_IMAGE_NAME: Image
      ENABLE_KERNELSU: true
      KERNELSU_TAG: v0.9.5
      ENABLE_LXC_DOCKER: true
      KERNEL_LOCALVERSION: -mikasa
    
    steps:
    - uses: actions/checkout@v3

    - name: æ„å»ºç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo -E apt-get -y -qq install git make bc bison ccache openssl zip kmod cpio flex libelf-dev curl libssl-dev libtfm-dev wget device-tree-compiler ca-certificates python3 binutils binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace
                     
    - name: ä¸‹è½½ zyc-clang ç¼–è¯‘å™¨ (Clang 18)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir clang-zyc
        wget https://github.com/ZyCromerZ/Clang/releases/download/18.0.0-20230903-release/Clang-18.0.0-20230903.tar.gz
        tar -C clang-zyc/ -zxf Clang-18.0.0-20230903.tar.gz
              
    - name: ä¸‹è½½å†…æ ¸æºç 
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1

    # --- æ ¸å¿ƒä¿®å¤ï¼šæ­£ç¡®çš„ GKI é…ç½®åˆå¹¶é€»è¾‘ ---
    - name: âš™ï¸ åˆå¹¶é…ç½® (Merge GKI Config)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        mkdir -p out
        
        # åˆå§‹åŒ–å˜é‡
        SELECTED_CONFIG=""
        USE_GKI_MERGE=false

        # 1. åˆ—å‡ºå¯ç”¨é…ç½®æ–‡ä»¶ (è°ƒè¯•ç”¨)
        echo "=== å¯ç”¨çš„é…ç½®æ–‡ä»¶ ==="
        ls -la arch/arm64/configs/ || true
        ls -la arch/arm64/configs/vendor/ || true
        
        # 2. è‡ªåŠ¨é€‰æ‹©æœ€ä½³é…ç½®
        if [ -f arch/arm64/configs/vendor/moonstone_defconfig ]; then
            SELECTED_CONFIG="vendor/moonstone_defconfig"
            echo "âœ“ å‘ç°å…¨é‡é…ç½®: $SELECTED_CONFIG"
        elif [ -f arch/arm64/configs/vendor/sunstone_defconfig ]; then
            SELECTED_CONFIG="vendor/sunstone_defconfig"
            echo "âœ“ å‘ç°å…¨é‡é…ç½®: $SELECTED_CONFIG"
        elif [ -f arch/arm64/configs/moonstone_defconfig ]; then
            SELECTED_CONFIG="moonstone_defconfig"
            echo "âœ“ å‘ç°é…ç½®: $SELECTED_CONFIG"
        elif [ -f arch/arm64/configs/vendor/moonstone_GKI.config ]; then
            USE_GKI_MERGE=true
            echo "âœ“ ä½¿ç”¨ GKI åˆå¹¶æ¨¡å¼: moonstone"
        elif [ -f arch/arm64/configs/vendor/sunstone_GKI.config ]; then
            USE_GKI_MERGE=true
            echo "âœ“ ä½¿ç”¨ GKI åˆå¹¶æ¨¡å¼: sunstone"
        else
            echo "Error: æ‰¾ä¸åˆ°ä»»ä½•åŒ¹é…çš„é…ç½®æ–‡ä»¶"
            exit 1
        fi
        
        # 3. æ ¹æ®é€‰æ‹©çš„æ¨¡å¼ç”Ÿæˆé…ç½®
        if [ "$USE_GKI_MERGE" = true ]; then
            # GKI åˆå¹¶æ¨¡å¼
            if [ -f arch/arm64/configs/vendor/moonstone_GKI.config ]; then
                ./scripts/kconfig/merge_config.sh -m -O out arch/arm64/configs/gki_defconfig arch/arm64/configs/vendor/moonstone_GKI.config
            else
                ./scripts/kconfig/merge_config.sh -m -O out arch/arm64/configs/gki_defconfig arch/arm64/configs/vendor/sunstone_GKI.config
            fi
        else
            # ç›´æ¥ä½¿ç”¨ defconfig
            make O=out ARCH=arm64 $SELECTED_CONFIG
        fi
        
        # 4. ä¿®å¤é…ç½® (olddefconfig)
        make O=out ARCH=arm64 olddefconfig
        
        # 5. ç¡®ä¿å…³é”® DTB é…ç½®å¼€å¯
        echo "=== æ£€æŸ¥å¹¶å¯ç”¨ DTB ç›¸å…³é…ç½® ==="
        # ç¡®ä¿ DTB è¿½åŠ åˆ° Image çš„é…ç½®å¼€å¯
        scripts/config --file out/.config --enable CONFIG_BUILD_ARM64_APPENDED_DTB_IMAGE || true
        scripts/config --file out/.config --enable CONFIG_BUILD_ARM64_DT_OVERLAY || true
        
        # é‡æ–°ç”Ÿæˆé…ç½®
        make O=out ARCH=arm64 olddefconfig
        
        echo "=== é…ç½®ç”Ÿæˆå®Œæˆ ==="
        ls -l out/.config

    - name: ä¿®å¤ Clang 18 ç¼–è¯‘æŠ¥é”™
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        
        # --- 1. ä¿®å¤ icnss2 é©±åŠ¨æŠ¥é”™ ---
        if [ -f drivers/soc/qcom/icnss2/main.c ]; then
            sed -i 's/struct icnss_priv \*icnss_get_plat_priv()/struct icnss_priv *icnss_get_plat_priv(void)/g' drivers/soc/qcom/icnss2/main.c
        fi
        
        # --- 2. ä¿®å¤ sm5602_fg.c è¯­æ³•é”™è¯¯ ---
        if [ -f drivers/power/supply/sm5602_fg.c ]; then
            sed -i 's/static old_uisoc = 0;/static int old_uisoc = 0;/g' drivers/power/supply/sm5602_fg.c
        fi
        
        # --- 3. ä¿®å¤ Focaltech è§¦æ§é©±åŠ¨ç¼ºæ–‡ä»¶ ---
        if [ -d drivers/input/touchscreen/FT3519T ]; then
            touch drivers/input/touchscreen/FT3519T/fw_sample.i
            echo "0x00" > drivers/input/touchscreen/FT3519T/fw_sample.i
            sed -i 's|"include/firmware/fw_sample.i"|"fw_sample.i"|g' drivers/input/touchscreen/FT3519T/focaltech_config.h
            
            mkdir -p drivers/input/touchscreen/FT3519T/include/pramboot
            echo "0x00" > drivers/input/touchscreen/FT3519T/include/pramboot/FT5452J_Pramboot_V4.1_20210427.i
        fi
        
        # --- 4. å…¨å±€ç¦ç”¨ä¸¥æ ¼æ£€æŸ¥ ---
        echo "KBUILD_CFLAGS += -Wno-error=strict-prototypes" >> Makefile
        echo "KBUILD_CFLAGS += -Wno-error" >> Makefile
        echo "KBUILD_CFLAGS += -Wno-error=frame-larger-than" >> Makefile
        echo "KBUILD_CFLAGS += -Wno-error=unused-but-set-variable" >> Makefile
        echo "KBUILD_CFLAGS += -Wno-error=unused-variable" >> Makefile
        
        # --- 5. æ”¾å®½æ ˆå¤§å°æ£€æŸ¥ ---
        find . -name "Makefile" -type f -exec sed -i 's/-Wframe-larger-than=[0-9]\+/-Wframe-larger-than=8192/g' {} \;

    - name: å¼€å¯ LXC å’Œ Docker é…ç½®
      if: env.ENABLE_LXC_DOCKER == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        chmod 755 $GITHUB_WORKSPACE/add-lxc-docker-custom.sh
        $GITHUB_WORKSPACE/add-lxc-docker-custom.sh android-kernel/out/.config
        # é‡æ–°ç”Ÿæˆé…ç½®ä»¥åº”ç”¨ LXC/Docker é€‰é¡¹
        cd android-kernel
        make O=out ARCH=arm64 olddefconfig

    - name: é…ç½® KernelSU (v0.9.5)
      if: env.ENABLE_KERNELSU == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5
        # KernelSU å¯èƒ½ä¿®æ”¹ Kconfigï¼Œé‡æ–°ç”Ÿæˆé…ç½®
        make O=out ARCH=arm64 olddefconfig

    - name: è®¾ç½® ccache ç¼“å­˜
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: build-kernel-moonstone-merged
        max-size: 2G

    - name: å¼€å§‹ç¼–è¯‘å†…æ ¸
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-zyc/bin:$PATH
        export KBUILD_BUILD_HOST=Github-Action
        export KBUILD_BUILD_USER=Builder
        
        # ç¡®è®¤é…ç½®å­˜åœ¨
        if [ ! -f out/.config ]; then
            echo "Critical Error: out/.config not found!"
            exit 1
        fi
        
        # ç¼–è¯‘å‚æ•°
        MAKE_ARGS="O=out ARCH=arm64 CC=clang CXX=clang++ CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LOCALVERSION=${{ env.KERNEL_LOCALVERSION }} LLVM=1 LLVM_IAS=1"
        
        # æ£€æŸ¥ DTS æºæ–‡ä»¶
        echo "=== æ£€æŸ¥ DTS æºæ–‡ä»¶ ==="
        find arch/arm64/boot/dts -name "*.dts" -type f 2>/dev/null | head -10
        ls -la arch/arm64/boot/dts/vendor/ 2>/dev/null || echo "vendor dts ç›®å½•ä¸å­˜åœ¨"
        ls -la arch/arm64/boot/dts/qcom/ 2>/dev/null || echo "qcom dts ç›®å½•ä¸å­˜åœ¨"
        
        # ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘ Image
        echo ""
        echo "=== ç¼–è¯‘ Image ==="
        make -j$(nproc --all) $MAKE_ARGS Image
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ ! -f out/arch/arm64/boot/Image ]; then
            echo "Error: Image ç¼–è¯‘å¤±è´¥ï¼"
            exit 1
        fi
        
        echo "âœ“ Image ç¼–è¯‘æˆåŠŸ"
        ls -lh out/arch/arm64/boot/Image
        
        # ç¬¬äºŒæ­¥ï¼šå•ç‹¬ç¼–è¯‘ DTBs
        echo ""
        echo "=== ç¼–è¯‘ DTBs ==="
        make -j$(nproc --all) $MAKE_ARGS dtbs || {
            echo "dtbs ç›®æ ‡å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼..."
            # æŸäº›å†…æ ¸å¯èƒ½éœ€è¦æŒ‡å®šå…·ä½“çš„ dtb ç›®æ ‡
            make -j$(nproc --all) $MAKE_ARGS qcom/holi.dtb 2>/dev/null || true
            make -j$(nproc --all) $MAKE_ARGS vendor/qcom/holi.dtb 2>/dev/null || true
        }
        
        # ç¬¬ä¸‰æ­¥ï¼šå°è¯•ç¼–è¯‘ Image.gz
        echo ""
        echo "=== ç¼–è¯‘ Image.gz ==="
        make -j$(nproc --all) $MAKE_ARGS Image.gz || true
        
        # ç¬¬å››æ­¥ï¼šæŸ¥æ‰¾ DTB æ–‡ä»¶
        echo ""
        echo "=== æŸ¥æ‰¾ DTB æ–‡ä»¶ ==="
        echo "åœ¨ out ç›®å½•ä¸­æœç´¢æ‰€æœ‰ .dtb æ–‡ä»¶:"
        find out -name "*.dtb" -type f 2>/dev/null
        
        # ç»Ÿè®¡ DTB æ–‡ä»¶
        DTB_COUNT=$(find out -name "*.dtb" -type f 2>/dev/null | wc -l)
        echo ""
        echo "æ‰¾åˆ° $DTB_COUNT ä¸ª DTB æ–‡ä»¶"
        
        # å¦‚æœæ²¡æœ‰ DTBï¼Œæ£€æŸ¥é…ç½®
        if [ "$DTB_COUNT" -eq 0 ]; then
            echo ""
            echo "âš ï¸ æœªæ‰¾åˆ° DTB æ–‡ä»¶ï¼Œæ£€æŸ¥ç›¸å…³é…ç½®:"
            grep -E "CONFIG_BUILD_ARM64.*DTB|CONFIG_OF|CONFIG_DTB" out/.config || true
        fi

    - name: ğŸ”§ æ‰‹åŠ¨æ‹¼æ¥ Image-dtb (å…³é”®æ­¥éª¤)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        
        BOOT_DIR="out/arch/arm64/boot"
        IMAGE_FILE="$BOOT_DIR/Image"
        
        echo "=== è°ƒè¯•ï¼šåˆ—å‡ºæ‰€æœ‰ DTB æ–‡ä»¶ ==="
        find out -name "*.dtb" -type f 2>/dev/null | head -30
        
        echo ""
        echo "=== è°ƒè¯•ï¼šåˆ—å‡º dts ç›®å½•ç»“æ„ ==="
        ls -laR out/arch/arm64/boot/dts/ 2>/dev/null | head -50 || echo "dts ç›®å½•ä¸å­˜åœ¨"
        
        # æŸ¥æ‰¾è®¾å¤‡å¯¹åº”çš„ DTB æ–‡ä»¶
        echo ""
        echo "=== æŸ¥æ‰¾è®¾å¤‡ DTB ==="
        
        DEVICE_DTB=""
        
        # æ–¹æ³•1: æŸ¥æ‰¾åŒ…å«è®¾å¤‡åçš„ DTB (æ‰©å±•æœç´¢èŒƒå›´)
        for pattern in "moonstone" "sunstone" "holi" "sm6225" "qcom" "bengal"; do
            FOUND_DTB=$(find out -name "*${pattern}*.dtb" -type f 2>/dev/null | head -1)
            if [ -n "$FOUND_DTB" ]; then
                DEVICE_DTB="$FOUND_DTB"
                echo "âœ“ æ‰¾åˆ°è®¾å¤‡ DTB: $DEVICE_DTB"
                break
            fi
        done
        
        # æ–¹æ³•2: åˆå¹¶æ‰€æœ‰æ‰¾åˆ°çš„ DTB
        if [ -z "$DEVICE_DTB" ]; then
            echo "æœªæ‰¾åˆ°ç‰¹å®šè®¾å¤‡ DTBï¼Œå°è¯•åˆå¹¶æ‰€æœ‰ DTB..."
            
            # æŸ¥æ‰¾æ‰€æœ‰ DTB æ–‡ä»¶
            ALL_DTBS=$(find out -name "*.dtb" -type f 2>/dev/null)
            
            if [ -n "$ALL_DTBS" ]; then
                echo "æ‰¾åˆ°ä»¥ä¸‹ DTB æ–‡ä»¶:"
                echo "$ALL_DTBS"
                
                # åˆå¹¶æ‰€æœ‰ DTB åˆ°ä¸€ä¸ªæ–‡ä»¶
                cat $ALL_DTBS > $BOOT_DIR/combined-dtb.dtb
                DEVICE_DTB="$BOOT_DIR/combined-dtb.dtb"
                echo "âœ“ åˆå¹¶äº†æ‰€æœ‰ DTB æ–‡ä»¶"
            fi
        fi
        
        # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ° DTB
        if [ -z "$DEVICE_DTB" ] || [ ! -f "$DEVICE_DTB" ]; then
            echo "âš ï¸ Warning: æœªæ‰¾åˆ°ä»»ä½• DTB æ–‡ä»¶ï¼"
            echo "å°†åªä½¿ç”¨çº¯ Image"
            echo ""
            echo "=== æ£€æŸ¥ DTB ç¼–è¯‘æ˜¯å¦æˆåŠŸ ==="
            # æ£€æŸ¥æ˜¯å¦æœ‰ dtb ç›¸å…³çš„ç¼–è¯‘è¾“å‡º
            find out -name "*.dtb*" -o -name "*.dts*" 2>/dev/null | head -20
        else
            echo "ä½¿ç”¨ DTB: $DEVICE_DTB"
            ls -lh "$DEVICE_DTB"
            
            # æ‹¼æ¥ Image + DTB
            echo ""
            echo "=== æ‹¼æ¥ Image-dtb ==="
            cat "$IMAGE_FILE" "$DEVICE_DTB" > "$BOOT_DIR/Image-dtb"
            
            echo "âœ“ Image-dtb ç”ŸæˆæˆåŠŸ:"
            ls -lh "$BOOT_DIR/Image-dtb"
            
            # å¦‚æœæœ‰ Image.gzï¼Œä¹Ÿç”Ÿæˆ Image.gz-dtb
            if [ -f "$BOOT_DIR/Image.gz" ]; then
                cat "$BOOT_DIR/Image.gz" "$DEVICE_DTB" > "$BOOT_DIR/Image.gz-dtb"
                echo "âœ“ Image.gz-dtb ç”ŸæˆæˆåŠŸ:"
                ls -lh "$BOOT_DIR/Image.gz-dtb"
            fi
        fi
        
        # æ˜¾ç¤ºæ‰€æœ‰ç”Ÿæˆçš„å†…æ ¸é•œåƒ
        echo ""
        echo "=== æ‰€æœ‰å†…æ ¸é•œåƒ ==="
        ls -lh $BOOT_DIR/Image* 2>/dev/null || true

    - name: ğŸ“Š éªŒè¯ç¼–è¯‘äº§ç‰©
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        BOOT_DIR="out/arch/arm64/boot"
        
        echo "=== ç¼–è¯‘äº§ç‰©æ£€æŸ¥ ==="
        
        # æ£€æŸ¥ Image å¤§å°
        if [ -f "$BOOT_DIR/Image" ]; then
            IMAGE_SIZE=$(stat -c%s "$BOOT_DIR/Image")
            IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
            echo "Image å¤§å°: ${IMAGE_SIZE_MB}MB ($IMAGE_SIZE bytes)"
        fi
        
        # æ£€æŸ¥ Image-dtb å¤§å°
        if [ -f "$BOOT_DIR/Image-dtb" ]; then
            IMAGE_DTB_SIZE=$(stat -c%s "$BOOT_DIR/Image-dtb")
            IMAGE_DTB_SIZE_MB=$((IMAGE_DTB_SIZE / 1024 / 1024))
            echo "Image-dtb å¤§å°: ${IMAGE_DTB_SIZE_MB}MB ($IMAGE_DTB_SIZE bytes)"
            
            # è­¦å‘Šï¼šå¦‚æœ Image-dtb å°äº 30MBï¼Œå¯èƒ½æœ‰é—®é¢˜
            if [ $IMAGE_DTB_SIZE_MB -lt 30 ]; then
                echo "âš ï¸ Warning: Image-dtb åªæœ‰ ${IMAGE_DTB_SIZE_MB}MBï¼ŒåŸå‚é€šå¸¸æ˜¯ 40MB å·¦å³"
                echo "å¯èƒ½ç¼ºå°‘æŸäº›é©±åŠ¨æˆ– DTB ä¸å®Œæ•´"
            else
                echo "âœ“ Image-dtb å¤§å°æ­£å¸¸"
            fi
        else
            echo "âš ï¸ Warning: Image-dtb æœªç”Ÿæˆï¼"
        fi
        
        # åˆ—å‡º DTB æ–‡ä»¶
        echo ""
        echo "=== DTB æ–‡ä»¶åˆ—è¡¨ ==="
        find out/arch/arm64/boot/dts -name "*.dtb" -type f 2>/dev/null | while read dtb; do
            size=$(stat -c%s "$dtb")
            echo "  $(basename $dtb): $((size/1024))KB"
        done | head -20

    - name: å‡†å¤‡æ‰“åŒ…å†…æ ¸ (AnyKernel3)
      run: |       
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://github.com/osm0sis/AnyKernel3 --depth=1
        
        BOOT_DIR="android-kernel/out/arch/arm64/boot"
        
        # 1. æ¸…ç†æ‚æ–‡ä»¶
        rm -rf AnyKernel3/.git* AnyKernel3/README.md AnyKernel3/ramdisk AnyKernel3/modules AnyKernel3/patch
        
        # 2. å¤åˆ¶å†…æ ¸é•œåƒ (ä¼˜å…ˆä½¿ç”¨ Image-dtb)
        echo "=== é€‰æ‹©å†…æ ¸é•œåƒ ==="
        if [ -f "$BOOT_DIR/Image-dtb" ]; then
            echo "âœ“ ä½¿ç”¨ Image-dtb (åŒ…å«è®¾å¤‡æ ‘)"
            cp "$BOOT_DIR/Image-dtb" AnyKernel3/Image
        elif [ -f "$BOOT_DIR/Image.gz-dtb" ]; then
            echo "âœ“ ä½¿ç”¨ Image.gz-dtb"
            cp "$BOOT_DIR/Image.gz-dtb" AnyKernel3/Image.gz
        elif [ -f "$BOOT_DIR/Image" ]; then
            echo "âš ï¸ ä½¿ç”¨çº¯ Image (æ—  DTBï¼Œå¯èƒ½æ— æ³•å¯åŠ¨)"
            cp "$BOOT_DIR/Image" AnyKernel3/
        else
            echo "Error: æ‰¾ä¸åˆ°ä»»ä½•å†…æ ¸é•œåƒï¼"
            exit 1
        fi
        
        # 3. å¤åˆ¶ dtbo.img (å¦‚æœå­˜åœ¨)
        if [ -f "$BOOT_DIR/dtbo.img" ]; then
            cp "$BOOT_DIR/dtbo.img" AnyKernel3/
            echo "âœ“ å¤åˆ¶ dtbo.img"
        fi
        
        # 4. åˆ›å»º dtb ç›®å½•å¹¶å¤åˆ¶æ‰€æœ‰ DTB æ–‡ä»¶
        mkdir -p AnyKernel3/dtb
        find android-kernel/out/arch/arm64/boot/dts -name "*.dtb" -type f -exec cp {} AnyKernel3/dtb/ \; 2>/dev/null
        DTB_COUNT=$(ls AnyKernel3/dtb/*.dtb 2>/dev/null | wc -l)
        echo "âœ“ å¤åˆ¶äº† $DTB_COUNT ä¸ª DTB æ–‡ä»¶åˆ° dtb/ ç›®å½•"
        
        # 5. ä¿®æ”¹ anykernel.sh
        cd AnyKernel3
        
        # åŸºæœ¬é…ç½®
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
        sed -i 's!block=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!block=auto;!g' anykernel.sh
        sed -i 's/is_slot_device=0/is_slot_device=auto/g' anykernel.sh
        
        # æ˜¾ç¤ºæœ€ç»ˆå†…å®¹
        echo ""
        echo "=== AnyKernel3 ç›®å½•å†…å®¹ ==="
        ls -lh
        
        # 6. æ‰“åŒ…
        zip -r9 $GITHUB_WORKSPACE/kernel_workspace/Final-Kernel.zip * -x .git README.md
        
        echo ""
        echo "=== æœ€ç»ˆåˆ·æœºåŒ… ==="
        ls -lh $GITHUB_WORKSPACE/kernel_workspace/Final-Kernel.zip
        
    - name: ä¸Šä¼ å†…æ ¸
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_ZIP_NAME }}
        path: kernel_workspace/Final-Kernel.zip
