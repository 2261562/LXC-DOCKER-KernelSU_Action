name: Redmi Note 12 5G (Stock Toolchain)
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel (Android Clang r383902b1)
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      # CodeLinaro msm-5.4 内核仓库 (SM6375/Holi 平台)
      KERNEL_SOURCE: https://git.codelinaro.org/clo/la/kernel/msm-5.4.git
      KERNEL_SOURCE_BRANCH: kernel.lnx.5.4.r1-rel
      # 原厂内核基于 5.4.191，编译时间 2022年10月
      # SM6375 (骁龙695) 对应 HOLI 平台，使用 LA.UM.9.16 分支
      # 可选 tag (HOLI 平台):
      #   - LA.UM.9.16.r1-13700-HOLI.QSSI13.0 (Android 13)
      #   - LA.UM.9.16.r1-14000-HOLI.QSSI14.0 (Android 14)
      # 注意: MANNAR 是 SM6225 (Khaje) 平台，不适用于 SM6375
      # 如果 tag 不存在，将使用分支最新 commit
      KERNEL_COMMIT: LA.UM.9.16.r1-13700-HOLI.QSSI13.0
      KERNEL_ZIP_NAME: beryl_lxc-docker-kernel_clo-msm54_20251219
      LLVM_CONFIG: y
      KERNEL_IMAGE_NAME: Image
      ENABLE_KERNELSU: true
      KERNELSU_TAG: v0.9.5
      ENABLE_LXC_DOCKER: true
      # 原厂 vermagic: 5.4.191-perf-g584efd44a591
      KERNEL_LOCALVERSION: -perf-g584efd44a591
      # 原厂工具链版本 (Android 12 时期)
      CLANG_VERSION: clang-r383902b1
    
    steps:
    - uses: actions/checkout@v3

    - name: 构建编译环境
      run: |
        sudo apt-get update
        sudo -E apt-get -y -qq install git make bc bison ccache openssl zip kmod cpio flex libelf-dev curl libssl-dev libtfm-dev wget device-tree-compiler ca-certificates python3 binutils binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: 下载 Android Clang 工具链
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p android-clang
        
        # 尝试多个 Clang 11 下载源
        CLANG_DOWNLOADED=false
        
        # 源1: ZyCromerZ Clang 11
        echo "尝试下载 ZyCromerZ Clang 11..."
        if wget -q --timeout=30 https://github.com/ZyCromerZ/Clang/releases/download/11.0.5-20210422-release/Clang-11.0.5-20210422.tar.gz -O clang.tar.gz 2>/dev/null && [ -s clang.tar.gz ]; then
          tar -xzf clang.tar.gz -C android-clang && CLANG_DOWNLOADED=true
          rm -f clang.tar.gz
        fi
        
        # 源2: 使用 aosp-clang (Google 官方镜像)
        if [ "$CLANG_DOWNLOADED" = false ]; then
          echo "尝试下载 aosp-clang r383902b1..."
          rm -f clang.tar.gz
          if wget -q --timeout=60 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android11-release/clang-r383902b1.tar.gz -O clang.tar.gz 2>/dev/null && [ -s clang.tar.gz ]; then
            tar -xzf clang.tar.gz -C android-clang && CLANG_DOWNLOADED=true
            rm -f clang.tar.gz
          fi
        fi
        
        # 源3: kdrag0n proton-clang (fallback)
        if [ "$CLANG_DOWNLOADED" = false ]; then
          echo "尝试克隆 proton-clang..."
          rm -rf android-clang
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git android-clang && CLANG_DOWNLOADED=true
        fi
        
        # 源4: neutron-clang (最后备选)
        if [ "$CLANG_DOWNLOADED" = false ]; then
          echo "尝试下载 neutron-clang..."
          mkdir -p android-clang
          cd android-clang
          curl -LO "https://raw.githubusercontent.com/AntaresOne/neutron-clang/main/antman.sh"
          bash antman.sh -S && CLANG_DOWNLOADED=true
          cd ..
        fi
        
        if [ "$CLANG_DOWNLOADED" = false ]; then
          echo "Error: 所有 Clang 下载源均失败!"
          exit 1
        fi
        
        # 验证 clang 版本
        echo "Clang 版本信息:"
        $GITHUB_WORKSPACE/kernel_workspace/android-clang/bin/clang --version

    - name: 下载 GCC 交叉编译器
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        
        # 使用 LineageOS 的 GCC 镜像 (更稳定)
        # aarch64 GCC (64位)
        git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 gcc64
        
        # arm GCC (32位，用于 vDSO)
        git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 gcc32

    - name: 下载内核源码 (CodeLinaro msm-5.4)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        
        # 浅克隆，使用分支最新 commit
        git clone ${{ env.KERNEL_SOURCE }} -b ${{ env.KERNEL_SOURCE_BRANCH }} android-kernel --depth=1
        
        cd android-kernel
        
        echo "当前 commit:"
        git log -1 --oneline
        
        # 删除 .git 目录，禁止 setlocalversion 脚本追加 git hash
        rm -rf .git

    - name: ⚙️ 生成内核配置 (CodeLinaro defconfig)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        mkdir -p out

        # CodeLinaro 仓库使用标准的 vendor defconfig 结构
        # SM6375 (骁龙695) 对应 holi 平台
        # 常见配置: vendor/holi-perf_defconfig 或 vendor/bengal-perf_defconfig
        
        if [ -f arch/arm64/configs/vendor/holi-perf_defconfig ]; then
            DEFCONFIG="vendor/holi-perf_defconfig"
        elif [ -f arch/arm64/configs/vendor/holi_defconfig ]; then
            DEFCONFIG="vendor/holi_defconfig"
        elif [ -f arch/arm64/configs/vendor/bengal-perf_defconfig ]; then
            DEFCONFIG="vendor/bengal-perf_defconfig"
        else
            echo "可用的 defconfig 列表:"
            ls -la arch/arm64/configs/vendor/ || ls -la arch/arm64/configs/
            echo "Error: 找不到合适的 defconfig"
            exit 1
        fi
        
        echo "使用配置: $DEFCONFIG"
        make O=out ARCH=arm64 $DEFCONFIG
        
        echo "配置生成完成"
        ls -l out/.config

    - name: 修复编译兼容性问题
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        
        # 修复 icnss2 驱动
        if [ -f drivers/soc/qcom/icnss2/main.c ]; then
            sed -i 's/struct icnss_priv \*icnss_get_plat_priv()/struct icnss_priv *icnss_get_plat_priv(void)/g' drivers/soc/qcom/icnss2/main.c
        fi
        
        # 修复 sm5602_fg.c 语法错误
        if [ -f drivers/power/supply/sm5602_fg.c ]; then
            sed -i 's/static old_uisoc = 0;/static int old_uisoc = 0;/g' drivers/power/supply/sm5602_fg.c
        fi
        
        # 修复 Focaltech 触控驱动
        if [ -d drivers/input/touchscreen/FT3519T ]; then
            touch drivers/input/touchscreen/FT3519T/fw_sample.i
            echo "0x00" > drivers/input/touchscreen/FT3519T/fw_sample.i
            sed -i 's|"include/firmware/fw_sample.i"|"fw_sample.i"|g' drivers/input/touchscreen/FT3519T/focaltech_config.h
            mkdir -p drivers/input/touchscreen/FT3519T/include/pramboot
            echo "0x00" > drivers/input/touchscreen/FT3519T/include/pramboot/FT5452J_Pramboot_V4.1_20210427.i
        fi

    - name: 开启 LXC 和 Docker 配置
      if: env.ENABLE_LXC_DOCKER == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        chmod 755 $GITHUB_WORKSPACE/add-lxc-docker-custom.sh
        $GITHUB_WORKSPACE/add-lxc-docker-custom.sh android-kernel/out/.config

    - name: 配置 KernelSU (v0.9.5)
      if: env.ENABLE_KERNELSU == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5

    - name: 设置 ccache 缓存
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: build-kernel-stock-toolchain
        max-size: 2G

    - name: 开始编译内核 (原厂工具链)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        
        # 设置工具链路径
        CLANG_PATH=$GITHUB_WORKSPACE/kernel_workspace/android-clang/bin
        GCC64_PATH=$GITHUB_WORKSPACE/kernel_workspace/gcc64/bin
        GCC32_PATH=$GITHUB_WORKSPACE/kernel_workspace/gcc32/bin
        
        export PATH=$CLANG_PATH:$GCC64_PATH:$GCC32_PATH:$PATH
        export KBUILD_BUILD_HOST=Github-Action
        export KBUILD_BUILD_USER=Builder
        
        if [ ! -f out/.config ]; then
            echo "Critical Error: out/.config not found!"
            exit 1
        fi
        
        # 使用原厂风格的编译参数
        # 原厂使用 Clang + GCC binutils 混合模式
        # LineageOS GCC 路径前缀
        make -j$(nproc --all) \
            O=out \
            ARCH=arm64 \
            CC="ccache clang" \
            CLANG_TRIPLE="aarch64-linux-gnu-" \
            CROSS_COMPILE="aarch64-linux-android-" \
            CROSS_COMPILE_COMPAT="arm-linux-androideabi-" \
            CROSS_COMPILE_ARM32="arm-linux-androideabi-" \
            LOCALVERSION="${{ env.KERNEL_LOCALVERSION }}" \
            LOCALVERSION_AUTO=n

    - name: 准备打包内核 (AnyKernel3)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://github.com/osm0sis/AnyKernel3
        
        rm -rf AnyKernel3/.git* AnyKernel3/README.md AnyKernel3/ramdisk AnyKernel3/modules AnyKernel3/patch
        
        if [ -f android-kernel/out/arch/arm64/boot/${{ env.KERNEL_IMAGE_NAME }} ]; then
            cp android-kernel/out/arch/arm64/boot/${{ env.KERNEL_IMAGE_NAME }} AnyKernel3/
        elif [ -f android-kernel/out/arch/arm64/boot/Image ]; then
            cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
        else
            echo "Error: Kernel image not found!"
            exit 1
        fi
        
        if [ -f android-kernel/out/arch/arm64/boot/dtbo.img ]; then
            cp android-kernel/out/arch/arm64/boot/dtbo.img AnyKernel3/
        fi

        cd AnyKernel3
        sed -i 's/block=\/dev\/block\/platform\/omap\/omap_hsmmc.0\/by-name\/boot;/block=\/dev\/block\/bootdevice\/by-name\/boot;/g' anykernel.sh
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
        sed -i 's/is_slot_device=0/is_slot_device=auto/g' anykernel.sh
        sed -i 's/kernel.string=zImage/kernel.string=Image/g' anykernel.sh
        
        zip -r9 $GITHUB_WORKSPACE/kernel_workspace/Final-Kernel.zip * -x .git README.md

    - name: 上传内核
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_ZIP_NAME }}
        path: kernel_workspace/Final-Kernel.zip
