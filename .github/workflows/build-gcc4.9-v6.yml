name: Redmi 6 Pro (Sakura) - LineageOS 16.0 修正版
on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel (Official LineageOS 16.0)
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    
    steps:
    - uses: actions/checkout@v3
    
    - name: 环境变量配置
      run: |
        cat config.env | grep KERNEL_ZIP_NAME= >> $GITHUB_ENV || echo "KERNEL_ZIP_NAME=Sakura_Kernel" >> $GITHUB_ENV
        cat config.env | grep ENABLE_KERNELSU= >> $GITHUB_ENV
        cat config.env | grep KERNELSU_TAG= >> $GITHUB_ENV

    - name: 构建编译环境
      run: |
        sudo apt-get update
        sudo -E apt-get -y -qq install git make bc bison ccache openssl zip kmod cpio flex libelf-dev curl libssl-dev libtfm-dev wget device-tree-compiler ca-certificates python2 binutils binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi
        sudo ln -sf /usr/bin/python2 /usr/bin/python
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: 下载 GCC 4.9 工具链
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b android-9.0.0_r61 --depth=1 gcc64
        git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 -b android-9.0.0_r61 --depth=1 gcc32
    
    - name: 下载 LineageOS 官方内核源码
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        echo "正在下载 LineageOS android_kernel_xiaomi_msm8953 (branch: lineage-16.0)..."
        git clone https://github.com/LineageOS/android_kernel_xiaomi_msm8953.git -b lineage-16.0 android-kernel --depth=1

    - name: 修复构建脚本 (GCC / DTC)
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        
        # 1. 禁用 GCC Wrapper
        if [ -f scripts/gcc-wrapper.py ]; then
            echo '#!/usr/bin/env python' > scripts/gcc-wrapper.py
            echo 'import os, sys' >> scripts/gcc-wrapper.py
            echo 'os.execvp(sys.argv[1], sys.argv[1:])' >> scripts/gcc-wrapper.py
            chmod +x scripts/gcc-wrapper.py
        fi
        
        # 2. 修复 DTC 兼容性 (-fcommon)
        sed -i 's/HOSTCFLAGS	+=/HOSTCFLAGS	+= -fcommon /g' scripts/dtc/Makefile
        if ! grep -q "-fcommon" scripts/dtc/Makefile; then
             sed -i '1s/^/HOSTCFLAGS += -fcommon\n/' scripts/dtc/Makefile
        fi

        # 3. 清理无效的编译器参数
        sed -i 's/-Werror-implicit-function-declaration//g' Makefile
        sed -i 's/-Werror//g' Makefile

    - name: 配置 KernelSU (可选)
      if: env.ENABLE_KERNELSU == 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        # 尝试集成 KSU，如果不兼容会自动跳过
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s ${{ env.KERNELSU_TAG }} || echo "KernelSU setup failed, continuing without it..."
               
    - name: 设置 ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: build-kernel-sakura-lineage16
        max-size: 2G

    - name: 开始编译内核
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace/android-kernel
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/gcc64/bin:$GITHUB_WORKSPACE/kernel_workspace/gcc32/bin:$PATH
        
        # --------------- 关键修改：智能 Defconfig 选择 ---------------
        # 1. 优先尝试 msm8953_defconfig (通用配置)
        TARGET_CONFIG="msm8953_defconfig"
        
        # 2. 检查文件是否存在，如果不存在则搜索可用的配置
        if [ ! -f "arch/arm64/configs/$TARGET_CONFIG" ]; then
            echo "警告：找不到 $TARGET_CONFIG，正在搜索可用配置..."
            ls arch/arm64/configs/ | grep 8953
            # 尝试自动切换到找到的第一个 msm8953 相关配置
            FOUND_CONFIG=$(ls arch/arm64/configs/ | grep "msm8953.*defconfig" | head -n 1)
            if [ ! -z "$FOUND_CONFIG" ]; then
                TARGET_CONFIG=$FOUND_CONFIG
                echo "自动切换到配置: $TARGET_CONFIG"
            else
                echo "错误：找不到任何 msm8953 相关的配置文件！"
                ls arch/arm64/configs/
                exit 1
            fi
        fi
        
        echo "使用配置文件: $TARGET_CONFIG"
        make O=out ARCH=arm64 $TARGET_CONFIG
        # ---------------------------------------------------------
        
        # 强制开启 Wi-Fi 模块编译
        script_config="out/.config"
        sed -i 's/# CONFIG_QCA_CLD3_WLAN is not set/CONFIG_QCA_CLD3_WLAN=m/' $script_config
        # 确保依赖项开启
        sed -i 's/# CONFIG_CFG80211 is not set/CONFIG_CFG80211=y/' $script_config
        sed -i 's/# CONFIG_MAC80211 is not set/CONFIG_MAC80211=y/' $script_config

        echo "开始编译..."
        make -j$(nproc --all) \
            O=out \
            ARCH=arm64 \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            KCFLAGS="-Wno-unused-function -Wno-error" || exit 1

    - name: 准备打包内核
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone https://github.com/osm0sis/AnyKernel3
        
        # AnyKernel3 配置
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
        sed -i 's!block=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!block=auto;!g' AnyKernel3/anykernel.sh
        sed -i 's/is_slot_device=1;/is_slot_device=0;/g' AnyKernel3/anykernel.sh
        sed -i 's/do.modules=0/do.modules=1/g' AnyKernel3/anykernel.sh
        
        # 复制 Image.gz-dtb
        cp android-kernel/out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        
        # ----------------- 提取内置 Wi-Fi 模块 -----------------
        echo "正在提取 Wi-Fi 模块..."
        mkdir -p AnyKernel3/modules/vendor/lib/modules
        
        # 搜索并复制所有 ko 模块
        find android-kernel/out -name "*.ko" -exec cp {} AnyKernel3/modules/vendor/lib/modules/ \;
        
        # 打印模块列表以供检查
        echo "已打包模块："
        ls -R AnyKernel3/modules/
        # -----------------------------------------------------

        rm -rf AnyKernel3/.git* AnyKernel3/README.md AnyKernel3/ramdisk AnyKernel3/patch
    
    - name: 打包并上传
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_ZIP_NAME }}_LineageOS16
        path: kernel_workspace/AnyKernel3/*